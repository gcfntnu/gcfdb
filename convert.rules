#-*- mode:snakemake -*-
"""Converters between common fileformats
"""

rule convert_gtf2gene_csv:
    input:
        join('{ref_dir}', 'genes', 'genes.gtf')
    params:
        script = srcdir('scripts/gtf2genes.py')
    output:
        join('{ref_dir}', 'genes', 'genes.tsv')
    singularity:
        'docker://quay.io/biocontainers/pyensembl:1.8.4--py_0'
    shell:
        'python {params.script} {input} > {output}'
        
rule convert_gtf2transcript_csv:
    input:
        join('{ref_dir}', 'genes', 'genes.gtf')
    params:
        script = srcdir('scripts/gtf2tx.py')
    output:
        join('{ref_dir}', 'genes', 'transcripts.tsv')
    singularity:
        'docker://quay.io/biocontainers/pyensembl:1.8.4--py_0'
    shell:
        'python {params.script} {input} > {output}'    

rule convert_gtf2txg:
    input:
        rules.convert_gtf2gene_csv.output
    output:
        join('{ref_dir}', 'genes', 'tx2gene.tsv')
    shell:
        'cut -f1,10 {input} > {output}'
        
rule convert_fasta2sequence_dict:
    input:
        join('{ref_dir}', 'fasta', 'genome.fa')
    output:
        join('{ref_dir}', 'fasta', 'genome.dict')
    singularity:
        'docker://broadinstitute/picard:2.21.1'    
    shell:
        'java -jar -Xms2g -Xmx2g /usr/picard/picard.jar CreateSequenceDictionary R={input} O={output}'
        
rule convert_gtf2bed12:
    input:
        join('{ref_dir}', 'genes', 'genes.gtf')
    output:
        join('{ref_dir}', 'genes', 'genes.bed12')
    params:
        tmpfile = join(TMPDIR, 'gene.genepred')
    singularity:
        'docker://gcfntnu/ucsc-scripts'
    shell:
        """
        gtfToGenePred -genePredExt -geneNameAsName2 {input} {params}
        genePredToBed {params} {output}
        rm {params.tmpfile}
        """
        
rule convert_gtf2intervals:
    input:
        join('{ref_dir}', 'genes', 'genes.gtf')
    output:
        join('{ref_dir}', 'genes', 'genes.intervals')
        
rule convert_gtf2refflat:
    input:
        join('{ref_dir}', 'genes', 'genes.gtf')
    output:
         join('{ref_dir}', 'genes', 'genes.refflat.gz')
    params:
        tmpfile = join(TMPDIR, 'refflat.tmp')
    singularity:
        'docker://gcfntnu/ucsc-scripts'
    shell:
        """
        gtfToGenePred -genePredExt -geneNameAsName2 {input} {params}
        paste <(cut -f 12 {params}) <(cut -f 1-10 {params}) > refFlat.txt
        rm {params.tmpfile}
        gzip refFlat.txt
        mv refFlat.txt.gz {output}
        """
        
rule convert_gtf_transcriptome_gffread:
    input:
        gtf = join('{ref_dir}', 'genes', 'genes.gtf'),
        genome = join('{ref_dir}', 'fasta', 'genome.fa')
    output:
        join('{ref_dir}', 'fasta', 'gtf.gffread.transcripts.fa')
    singularity:
        'docker://quay.io/biocontainers/gffread:0.11.4--hdbcaa40_0'
    shell:
        'gffread -w {output} -G -E -g {input.genome} {input.gtf}'
        
rule convert_gtf_transcriptome_rsem:
    input:
        gtf = join('{ref_dir}', 'genes', 'genes.gtf'),
        genome = join('{ref_dir}', 'fasta', 'genome.fa')
    params:
        base = join('{ref_dir}', 'fasta', 'gtf.rsem')
    singularity:
        'docker://quay.io/biocontainers/rsem:1.3.2--pl526ha52163a_1'
    output:
        join('{ref_dir}', 'fasta', 'gtf.rsem.transcripts.fa')
    shell:
        'rsem-prepare-reference --gtf {input.gtf} {input.genome} {params.base}'
