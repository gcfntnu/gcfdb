#-*- mode:snakemake -*-
"""Extra reference sequences for unitas.

Additional files that contain reference sequeces in FASTA format. FASTA headers should have the following format: >ncRNA_type|ncRNA_name 

This will be added to ncRNA.fas
"""
include:
    'contaminants.db'

CALIBRATORS_EXTEND = config['filter'].get('calibrators_extend', False)
UNITAS_REFSEQ = []

_unitas_map = {'homo_sapiens': 'Human',
              'human': 'Human',
               'hsa': 'Human',
               'mus_musculus': 'Mouse',
               'mouse': 'Mouse',
               'mmu': 'Mouse'}
UNITAS_ORG = _unitas_map[config['organism']]

rule unitas_dummy_input:
    output:
        temp(touch('.unitas_dummy.txt'))

rule contaminants_unitas:
    input:
        join(EXT_DIR, 'univec_core', 'fasta', 'univec_core.fa')
    params:
        script = srcdir('scripts/contaminants_unitas.py')
    output:
        temp(join(INTERIM_DIR, '_contaminants_unitas_formatted.fa'))
    shell:
        'python {params.script} {input} > {output}'

rule unitas_local:
    input:
        rules.unitas_dummy_input.output
    output:
        dir = directory('UNITAS_refdump_{}'.format(ORG)),
        db_log = join('UNITAS_refdump_{}'.format(ORG), 'db_versions.info'),
        seqmap_exe = 'seqmap.exe'
    params:
        outdir = 'UNITAS_refdump_{}'.format(ORG)
    singularity:
        'docker://' + config['docker']['unitas']     
    shell:
        """
        unitas.pl -latest_ref -species {ORG} -input {input}
        """


rule unitas_db:
    input:
        dir = rules.unitas_local.output.dir,
        seqmap_exe = rules.unitas_local.output.seqmap_exe
    output:
        db_log = join(EXT_DIR, 'unitas', 'UNITAS_refdump_{}'.format(ORG), 'db_versions.info'),
        seqmap_exe = join(EXT_DIR, 'unitas', 'seqmap.exe'),
        mb = join(EXT_DIR, 'unitas', 'UNITAS_refdump_{}'.format(ORG), 'miRBase_hairpin')
    params:
        outdir = join(EXT_DIR, 'unitas'),
        script = srcdir('scripts/format_unitas_dblog.py')
    log:
        join(EXT_DIR, 'unitas', 'UNITAS_refdump_{}'.format(ORG), 'logs', 'unitas.log')
    singularity:
        'docker://' + config['docker']['default']   
    shell:
        """
        mv {input.dir } {params.outdir}
        mv {input.seqmap_exe} {output.seqmap_exe}
        python {params.script} {output.db_log} > {log}
        """

rule unitas_db_all:
    input:
        join(EXT_DIR, 'unitas', 'UNITAS_refdump_{}'.format(ORG), 'miRBase_hairpin')
