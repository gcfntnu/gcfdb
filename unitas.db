#-*- mode:snakemake -*-
"""Extra reference sequences for unitas.

Additional files that contain reference sequeces in FASTA format. FASTA headers should have the following format: >ncRNA_type|ncRNA_name 

This will be added to ncRNA.fas
"""
from os.path import join

CALIBRATORS_EXTEND = config['filter'].get('calibrators_extend', False)
UNITAS_REFSEQ = []
_unitas_map = {'homo_sapiens': 'Human',
              'human': 'Human',
               'hsa': 'Human',
               'mus_musculus': 'Mouse',
               'mouse': 'Mouse',
               'mmu': 'Mouse'}
UNITAS_ORG = _unitas_map[config.get('organism')]


if config['filter'].get('filter_calibrators'):
    if config['filter']['calibrator_quantifier'] == 'unitas':
        UNITAS_REFSEQ.append(rules.calibrators_extend.output if CALIBRATORS_EXTEND else rules.calibrators_to_dna.output)
if config['filter'].get('filter_contaminants'):
    if config['filter']['contaminant_quantifier'] == 'unitas':
        UNITAS_REFSEQ.append(rules.contaminants_unitas.output)

rule unitas_extra_reference:
    input:
        UNITAS_REFSEQ
    output:
        join(EXT_DIR, 'unitas', 'refseq.fa')
    shell:
        'cat {input} > {output}'

rule unitas_db:   
    output:
        directory(join(EXT_DIR, 'unitas', 'UNITAS_refdump_{}'.format(ORG)))
    singularity:
        'docker://gcfntnu/unitas:1.7.0'     
    shell:
        """
        unitas.pl -latest_ref -species {ORG} -input haha.txt
        mv UNITAS_refdump_* {EXT_DIR}/unitas/
        """
