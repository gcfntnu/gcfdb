#-*- mode:snakemake -*-
"""10xgenomics external data and reference/index builds

support.10xgenomics.com/single-cell-gene-expression/software/downloads

"""

_URLS= {
    'homo_sapiens': 'http://cf.10xgenomics.com/supp/cell-exp/refdata-cellranger-GRCh38-3.0.0.tar.gz',
    'mus_musculus': 'http://cf.10xgenomics.com/supp/cell-exp/refdata-cellranger-mm10-3.0.0.tar.gz',
    'homo_sapiens__mus_musculus': 'http://cf.10xgenomics.com/supp/cell-exp/refdata-cellranger-GRCh38-and-mm10-3.1.0.tar.gz',
    'ercc': 'http://cf.10xgenomics.com/supp/cell-exp/refdata-cellranger-ercc92-1.2.0.tar.gz',
    'whitelist_url': 'https://folk.ntnu.no/geiramh/10xgenomics',
   'sc3pv2_indexset': 'http://cf.10xgenomics.com/supp/cell-exp/chromium-shared-sample-indexes-plate.csv'
}

_ASSEMBLY = {'homo_sapiens': 'GRCh38'
             'mus_musculus': 'GRCm38'
             'homo_sapiens__mus_musculus': 'GRCh37_GRCm37'
}

from os.path import join

extra_conf_fn = srcdir('10xgenomics.config')
if os.path.exists(extra_conf_fn):
    with open(extra_conf_fn) as fh:
        c  = yaml.load(fh) or {}
        update_config2(config, c)

# config
ORG = config.get('organism', 'homo_sapiens')
if org not in ['homo_sapiens', 'mus_musculus', 'homo_sapiens__mus_musculus']:
    raise ValueError('No 10x prebuild for org: {}'.format(ORG))
TX_CONFIG = config['db'].get('10xgenomics', {})
_NAME = TX_CONFIG['assembly'] = _ASSEMBLY[ORG]
TX_EXT = join(EXT_DIR, '10xgenomics', ORG, _NAME)

rule txgenomics_whitelist:
    params:
        fn = LIBPREP['cellranger']['whitelist'],
        url = _URLS['whitelist_url']
    output:
        join(EXT_DIR, '10xgenomics', 'whitelist.txt')
    shell:
        'wget -O {output} {params.url}/{params.fn}'

rule txgenomics_org_prebuild:
    params:
        url = _URLS[ORG],
        out = TX_EXT
    output:
        json = join(TX_EXT, 'reference.json'),
        gtf = join(TX_EXT, 'genes', 'genes.gtf'),
        fasta = join(TX_EXT, 'fasta', 'genome.fa'),
        star_index = join(TX_EXT, 'star', 'SA')
    shell:
        'curl {params.url} | tar xvz --strip-components=1 -C {params.out}'
