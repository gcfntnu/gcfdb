#-*- mode:snakemake -*-
"""miRge - microRNA alignment software for small RNA-seq data

https://github.com/mhalushka/miRge


This is the database download part.

For DB builds: https://github.com/mhalushka/miRge_build

"""
from os.path import join

ORG = config.get('organism', 'homo_sapiens')
MIRGE_EXT = join(EXT_DIR, 'mirge', ORG)

URLS =  {'human':
         'https://jh.box.com/shared/static/rj7ufy5v15uw7ytsyyrsryw99u7ml82j.gz',
         'mouse':
         'mouse.tar.gz https://jh.box.com/shared/static/z2bcey8j9e9nxnvpmb4fm88zzq3da4m1.gz',
         'rat':
         'rat.tar.gz https://jh.box.com/shared/static/mmztv42j8h7snk0eo80o7a7t30it4q9f.gz',
         'zebrafish':
         'https://jh.box.com/shared/static/nwn7jzn5ekgm51k7jlk43a6h75aasgr1.gz',
         'nematode':
         'https://jh.box.com/shared/static/nwn7jzn5ekgm51k7jlk43a6h75aasgr1.gz',
         'fruitfly':
         'fruitfly.tar.gz https://jh.box.com/shared/static/ilrnq62cp06pviir5t0mh85aqet0fmjq.gz'
         }

MIRGE_ORG = {'homo_sapiens': 'human',
           'human': 'human',
           'human': 'human',
           'mus_musculus': 'mouse',
           'mouse': 'mouse',
           'mouse': 'mouse',
           'rattus_norvegicus': 'rat',
           'rat': 'rat',
           'rat': 'rat'}

rule mirge_download_db:
    params:
        url = URLS[MIRGE_ORG[ORG]],
        out = MIRGE_EXT
    output:
        join(MIRGE_EXT, 'index.Libs', '{}_snorna.3.ebwt'.format(MIRGE_ORG[ORG]))
    shell:
        'wget -qO- {params.url} | tar xvz --strip-components 1 -C {params.out}'

rule mirge_add_trf_human:
    input:
        rules.mirge_download_db.output
    params:
        url = 'https://github.com/mhalushka/miRge/files/2428450/missingtrffiles.zip',
        outdir = join(MIRGE_EXT, 'annotation.Libs')
    output:
        join(MIRGE_EXT, 'annotation.Libs', 'human_trna.str')
    shell:
        """
        wget {params.url}
        unzip missingtrffiles.zip -d {params.outdir}
        rm missingtrffiles.zip
        """

rule mirge_db:
    input:
        'data/ext/mirge/{0}/index.Libs/{1}_snorna.3.ebwt'.format(ORG, MIRGE_ORG[ORG])
        
        
